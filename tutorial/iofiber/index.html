<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>IOFiber - IOFiber</title>
  <meta property="og:title" content="IOFiber" />
  <meta name="twitter:title" content="IOFiber" />
  <meta name="description" content="Fibers are lightweight threads managed in user-space. Fibers from this library are:
   Stackful.
  Cooperative.
  Use Boost.Asio execution contexts (e.g. boost::asio::io_context) as schedulers. Any async function will work as a suspension point.
  Non-symmetric. Main fiber and secondary fibers are exposed to different APIs. There is a clear separation between fibers that run inside and outside ASIO&#8217;s execution contexts.
   trial::iofiber::fiber is an alias for trial::iofiber::basic_fiber&lt;boost::asio::io_context::strand&gt;.">
  <meta property="og:description" content="Fibers are lightweight threads managed in user-space. Fibers from this library are:
   Stackful.
  Cooperative.
  Use Boost.Asio execution contexts (e.g. boost::asio::io_context) as schedulers. Any async function will work as a suspension point.
  Non-symmetric. Main fiber and secondary fibers are exposed to different APIs. There is a clear separation between fibers that run inside and outside ASIO&#8217;s execution contexts.
   trial::iofiber::fiber is an alias for trial::iofiber::basic_fiber&lt;boost::asio::io_context::strand&gt;.">
  <meta name="twitter:description" content="Fibers are lightweight threads managed in user-space. Fibers from this library are:
   Stackful.
  Cooperative.
  Use Boost.Asio execution contexts (e.g. boost::asio::io_context) as schedulers. Any …"><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "IOFiber",
    
    "url": "https:\/\/vinipsmaker.github.io\/iofiber\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/vinipsmaker.github.io\/iofiber\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/vinipsmaker.github.io\/iofiber\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/vinipsmaker.github.io\/iofiber\/tutorial\/iofiber\/",
          "name": "I o fiber"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : ""
  },
  "headline": "IOFiber",
  "description" : "Fibers are lightweight threads managed in user-space. Fibers from this library are:\n   Stackful.\n  Cooperative.\n  Use Boost.Asio execution contexts (e.g. boost::asio::io_context) as schedulers. Any async function will work as a suspension point.\n  Non-symmetric. Main fiber and secondary fibers are exposed to different APIs. There is a clear separation between fibers that run inside and outside ASIO\u0026#8217;s execution contexts.\n   trial::iofiber::fiber is an alias for trial::iofiber::basic_fiber\u0026lt;boost::asio::io_context::strand\u0026gt;.",
  "inLanguage" : "en",
  "wordCount":  574 ,
  "datePublished" : "0001-01-01T00:00:00",
  "dateModified" : "0001-01-01T00:00:00",
  "image" : "https:\/\/vinipsmaker.github.io\/iofiber\/",
  "keywords" : [ "" ],
  "mainEntityOfPage" : "https:\/\/vinipsmaker.github.io\/iofiber\/tutorial\/iofiber\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/vinipsmaker.github.io\/iofiber\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/vinipsmaker.github.io\/iofiber\/",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="IOFiber" />
<meta property="og:description" content="Fibers are lightweight threads managed in user-space. Fibers from this library are:
   Stackful.
  Cooperative.
  Use Boost.Asio execution contexts (e.g. boost::asio::io_context) as schedulers. Any async function will work as a suspension point.
  Non-symmetric. Main fiber and secondary fibers are exposed to different APIs. There is a clear separation between fibers that run inside and outside ASIO&#8217;s execution contexts.
   trial::iofiber::fiber is an alias for trial::iofiber::basic_fiber&lt;boost::asio::io_context::strand&gt;.">
<meta property="og:url" content="https://vinipsmaker.github.io/iofiber/tutorial/iofiber/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="IOFiber" />
  <meta name="twitter:title" content="IOFiber" />
  <meta name="twitter:description" content="Fibers are lightweight threads managed in user-space. Fibers from this library are:
   Stackful.
  Cooperative.
  Use Boost.Asio execution contexts (e.g. boost::asio::io_context) as schedulers. Any …">
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="https://vinipsmaker.github.io/iofiber/tutorial/iofiber/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="IOFiber" />

  <meta name="generator" content="Hugo 0.73.0" />
  <link rel="alternate" href="https://vinipsmaker.github.io/iofiber/index.xml" type="application/rss+xml" title="IOFiber">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://vinipsmaker.github.io/iofiber/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://vinipsmaker.github.io/iofiber/css/highlight.min.css" /><link rel="stylesheet" href="https://vinipsmaker.github.io/iofiber/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://vinipsmaker.github.io/iofiber/">IOFiber</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Tutorials(7)" href="/iofiber/tutorial/">Tutorials(7)</a>
            </li>
          
        
          
            <li>
              <a title="Reference(3)" href="/iofiber/ref/">Reference(3)</a>
            </li>
          
        

        

        
      </ul>
    </div>

    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="tutorial-heading">
              
                <h1>IOFiber</h1>
              
              
                <hr class="small">
              
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <div class="paragraph">
<p>Fibers are lightweight threads managed in user-space. Fibers from this library
are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stackful.</p>
</li>
<li>
<p>Cooperative.</p>
</li>
<li>
<p>Use Boost.Asio execution contexts (e.g. <code>boost::asio::io_context</code>) as
schedulers. Any async function will work as a suspension point.</p>
</li>
<li>
<p>Non-symmetric. Main fiber and secondary fibers are exposed to different
APIs. There is a clear separation between fibers that run inside and outside
ASIO&#8217;s execution contexts.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>trial::iofiber::fiber</code> is an alias for
<code>trial::iofiber::basic_fiber&lt;boost::asio::io_context::strand&gt;</code>. To spawn a
fiber, pass a strand <code>executor</code> and a fiber <code>start-function</code> to <code>fiber</code>
constructor. Fiber will be scheduled through <code>executor</code> and use it throughout
its lifetime and <code>start-function</code> will be executed on top of fiber&#8217;s stack:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">boost::asio::io_context ctx;
boost::asio::io_context::strand strand{ctx};

fiber(
  strand,
  [](fiber::this_fiber this_fiber) {
    std::cout &lt;&lt; "Hello World" &lt;&lt; std::endl;
  }
).detach();

ctx.run();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The start-function must have a <code>fiber::this_fiber</code> parameter through which it
can have access to local/private<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> functions. There is a second constructor to instantiate a strand for
you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">boost::asio::io_context ctx;

fiber(
  ctx,
  [](fiber::this_fiber this_fiber) {
    std::cout &lt;&lt; "Hello World" &lt;&lt; std::endl;
  }
).detach();

ctx.run();</code></pre>
</div>
</div>
<div class="paragraph">
<p>And there is a third constructor which will reuse the strand from the parent
fiber:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">boost::asio::io_context ctx;

fiber(
  ctx,
  [](fiber::this_fiber this_fiber) {
    fiber(
      this_fiber,
      [](fiber::this_fiber this_fiber) {
        std::cout &lt;&lt; " World" &lt;&lt; std::endl;
      }
    ).detach();

    std::cout &lt;&lt; "Hello";
  }
).detach();

ctx.run();</code></pre>
</div>
</div>
<div class="paragraph">
<p>All <code>fiber</code> objects must be either <code>join()</code>'ed or <code>detach()</code>'ed. If you
don&#8217;t call any of these functions, <code>fiber</code>'s destructor will call
<code>strand.context().stop()</code> function to stop the application (a less severe
alternative to <code>std::terminate()</code>). You can check whether the application
finished normally or abnormally using <code>trial::iofiber::context_aborted()</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Implementation details</div>
<div class="paragraph">
<p>It follows a design similar to POSIX threads:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Failure to join with a thread that is joinable (i.e., one that is not detached),
produces a "zombie thread".  Avoid doing this, since each zombie thread consumes
some system resources, and when enough zombie threads have accumulated, it will
no longer be possible to create new threads (or processes).</p>
</div>
</blockquote>
<div class="attribution">
&#8212; pthread_join(3)
</div>
</div>
<div class="paragraph">
<p>As of our fibers, each fiber will call <code>strand.on_work_started()</code> and the
matching <code>strand.on_work_finished()</code> will only be called when you either
<code>join()</code> or <code>detach()</code> a fiber. This behaviour allows you to safely join fibers
from other execution contexts even if the foreign execution context runs out of
work<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>.</p>
</div>
<div class="paragraph">
<p><code>std::thread</code> design evolution is also followed by having a movable object whose
destructor will stop the world if it detects an error in the code logic.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">boost::asio::io_context ioctx;

fiber f1(
  ioctx,
  [](fib::fiber::this_fiber this_fiber) {
    boost::asio::steady_timer timer{this_fiber.get_executor().context()};

    std::cout &lt;&lt; "3..." &lt;&lt; std::flush;
    timer.expires_after(std::chrono::seconds(1));
    timer.async_wait(this_fiber);

    std::cout &lt;&lt; " 2..." &lt;&lt; std::flush;
    timer.expires_after(std::chrono::seconds(1));
    timer.async_wait(this_fiber);

    std::cout &lt;&lt; " 1..." &lt;&lt; std::endl;
    timer.expires_after(std::chrono::seconds(1));
    timer.async_wait(this_fiber);
  }
);

fiber(
  ioctx,
  [&amp;f1](fib::fiber::this_fiber this_fiber) {
    f1.join(this_fiber);

    std::cout &lt;&lt; "Hello World" &lt;&lt; std::endl;
  }
).detach();

ioctx.run();</code></pre>
</div>
</div>
<div class="sect1">
<h2 id="_fiberthis_fiber"><code>fiber::this_fiber</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>this_fiber</code> object passed to the fiber start-function is a completion token
and you can use it with any Boost.Asio&#8217;s <code>async_*</code> function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void start(fiber::this_fiber this_fiber)
{
  boost::asio::steady_timer timer{this_fiber.get_executor().context()};
  timer.expires_after(std::chrono::seconds(1));
  try {
    timer.async_wait(this_fiber);
    // ...
  } catch (const boost::system::system_error&amp; e) {
    // ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to handle <code>boost::system::error_code</code> errors directly instead having
them translated to exceptions, use the <code>operator[]</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void start(fiber::this_fiber this_fiber)
{
  boost::asio::steady_timer timer{this_fiber.get_executor().context()};
  timer.expires_after(std::chrono::seconds(1));

  boost::system::error_code ec;
  timer.async_wait(this_fiber[ec]);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another ability <code>this_fiber</code> provides you is the ability to do spurious yields:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">this_fiber.yield();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see_also">See also:</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="../interruption/"><code>interruption(7)</code></a></p>
</li>
</ul>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. API to fiber management which is only available from within the fiber itself and not through remote/foreign fibers.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. ASIO&#8217;s strands are used extensively to do non-blocking synchronization and access to shared state. In the case of <code>join()</code>, the strand methods will be no-ops by the time <code>boost::asio::io_context::run()</code> returns, so we need to keep&#8217;em busy.
</div>
</div>


        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
          
            <li class="next">
              <a href="https://vinipsmaker.github.io/iofiber/tutorial/interruption/" data-toggle="tooltip" data-placement="top" title="Interruption">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;&copy;
          
            0001
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://vinipsmaker.github.io/iofiber/">IOFiber</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.73.0</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://vinipsmaker.github.io/iofiber/js/main.js"></script>
<script src="https://vinipsmaker.github.io/iofiber/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script>
<script src="https://vinipsmaker.github.io/iofiber/js/load-photoswipe.js"></script>








  </body>
</html>

